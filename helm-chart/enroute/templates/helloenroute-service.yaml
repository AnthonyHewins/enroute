{{- if .Values.helloenrouteService.create -}}
---
apiVersion: v1
kind: Service
metadata:
  name: hello-enroute
  namespace: {{ .Values.globalSettings.namespace.name }}
  labels:
    app: hello-enroute
spec:
  type: ClusterIP
  ports:
  - name: http
    port: 9090
    targetPort: 8080
  - name: https
    port: 9091
    targetPort: 8081
  selector:
    app: hello-enroute
---
apiVersion: enroute.saaras.io/v1beta1
kind: GlobalConfig
metadata:
  labels:
    app: hello-enroute
  name: rl-global-config
  namespace: {{ .Values.globalSettings.namespace.name }}
spec:
  name: rl-global-config
  type: globalconfig_ratelimit
# for every xff, with proto https for default_route, enforce 2rps
# enroute_x-forwarded-for_10.0.20.90_x-forwarded-proto_https_generic_key_default_route_1617919413
  config: |
        {
          "domain": "enroute",
          "descriptors" :
          [
            {
              "key": "x-forwarded-for",
              "descriptors" :
              [
                {
                  "key" : "x-forwarded-proto",
                  "value" : "http",
                  "descriptors" : [
                   {
                     "key" : "generic_key",
                     "value" : "default_route",
                     "rate_limit" : { "unit" : "second", "requests_per_unit" : 1 }
                    }
                  ]
                },
                {
                  "key" : "x-forwarded-proto",
                  "value" : "https",
                  "descriptors" : [
                   {
                     "key" : "generic_key",
                     "value" : "default_route",
                     "rate_limit" : { "unit" : "second", "requests_per_unit" : 2 }
                   }
                  ]
                }
              ]
            }
          ]
        }
---
apiVersion: enroute.saaras.io/v1beta1
kind: RouteFilter
metadata:
  labels:
    app: hello-enroute
  name: rl2
  namespace: {{ .Values.globalSettings.namespace.name }}
spec:
  name: rl2
  type: route_filter_ratelimit
  routeFilterConfig:
    config: |
          { 
            "descriptors" : 
            [ 
              { "request_headers": { "header_name": "x-forwarded-for", "descriptor_key": "x-forwarded-for" } },
              { "request_headers": { "header_name": "x-forwarded-proto", "descriptor_key": "x-forwarded-proto" } },
              { "generic_key": { "descriptor_value" : "default_route" } }
            ]
          }
---
apiVersion: enroute.saaras.io/v1beta1
kind: HttpFilter
metadata:
  labels:
    app: hello-enroute
  name: luatestfilter
  namespace: {{ .Values.globalSettings.namespace.name }}
spec:
  name: luatestfilter
  type: http_filter_lua
  httpFilterConfig:
    config: |
        function envoy_on_request(request_handle)
           request_handle:logInfo("Hello World request");
        end

        function envoy_on_response(response_handle)
           response_handle:logInfo("Hello World response");
        end
---
apiVersion: enroute.saaras.io/v1beta1
kind: HttpFilter
metadata:
  labels:
    app: hello-enroute
  name: corsfilter
  namespace: {{ .Values.globalSettings.namespace.name }}
spec:
  name: corsfilter
  type: http_filter_cors
  httpFilterConfig:
    config: |
         {
             "match_condition" : {
               "regex" : "\\*"
             },
             "access_control_allow_methods" : "GET, OPTIONS",
             "access_control_allow_headers" : "Content-Type",
             "access_control_expose_headers" : "*",
             "access_control_max_age" : "120"
         }
---
apiVersion: enroute.saaras.io/v1beta1
kind: HttpFilter
metadata:
  labels:
    app: hello-enroute
  name: jwtfilter
  namespace: {{ .Values.globalSettings.namespace.name }}
spec:
  name: jwtfilter
  type: http_filter_jwt
  services:
     name: externalauth
     port: 443
     protocol: tls
  httpFilterConfig:
    config: |
         {
           "name" : "auth0",
           "jwks_uri" : "https://saaras.auth0.com/.well-known/jwks.json",
           "audience" : "api-identifier",
           "issuer" : "https://saaras.auth0.com/",
           "route" : [{"prefix" : "/"}],
           "jwt_service_name" : "auth0",
           "jwt_service_port" : 443,
           "jwt_forward_header_name" : "x-jwt-token"
         }
---
apiVersion: v1
kind: Service
metadata:
  name: externalauth
  namespace: {{ .Values.globalSettings.namespace.name }}
spec:
  type: ExternalName
  externalName: saaras.auth0.com
  ports:
  - port: 443
  # important to set protocol name
    name: https
---
apiVersion: enroute.saaras.io/v1beta1
kind: GatewayHost
metadata:
  labels:
    app: hello-enroute
  name: helloenroute-gatewayhost
  namespace: {{ .Values.globalSettings.namespace.name }}
spec:
  virtualhost:
    fqdn: '*'
    filters:
      - name: luatestfilter
        type: http_filter_lua
      - name: corsfilter
        type: http_filter_cors
      - name: jwtfilter
        type: http_filter_jwt
  routes:
    - conditions:
      - prefix: /
        header:
          name: ":method"
          exact: "GET"
      filters:
        - name: rl2
          type: route_filter_ratelimit
      services:
        - name: hello-enroute
          port: 9090
{{- end }}
